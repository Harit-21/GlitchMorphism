<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Builder Timer with Backend</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 flex flex-col items-center">
  <h1 class="text-4xl font-bold mb-6">Builder Timers (Backend)</h1>
  
  <form id="add-timer-form" class="mb-6 flex gap-2">
    <input type="text" id="name" placeholder="Builder Name" required class="p-2 rounded text-black" />
    <input type="text" id="duration" placeholder="Duration e.g. 1d2h30m" required class="p-2 rounded text-black" />
    <button type="submit" class="bg-green-600 px-4 rounded hover:bg-green-700">Add Timer</button>
  </form>

  <div id="timers" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 w-full max-w-4xl"></div>

<script>
  const apiBase = ''; // If served on same origin; else put backend URL

  async function fetchTimers() {
    const res = await fetch(`${apiBase}/timers`);
    if (!res.ok) return [];
    return await res.json();
  }

  async function addTimer(name, duration) {
    const res = await fetch(`${apiBase}/timers`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name, duration})
    });
    if (!res.ok) alert('Failed to add timer');
  }

  async function deleteTimer(id) {
    await fetch(`${apiBase}/timers/${id}`, { method: 'DELETE' });
  }

  function formatRemaining(sec) {
    const d = Math.floor(sec / 86400);
    sec %= 86400;
    const h = Math.floor(sec / 3600);
    sec %= 3600;
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${d}d ${h}h ${m}m ${s}s`;
  }

  function renderTimers(timers) {
    const container = document.getElementById('timers');
    container.innerHTML = '';
    if (timers.length === 0) {
      container.textContent = 'No active timers.';
      return;
    }
    timers.forEach(timer => {
      const div = document.createElement('div');
      div.className = 'bg-gray-800 p-4 rounded shadow flex justify-between items-center';
      div.innerHTML = `
        <div>
          <h2 class="font-bold text-xl">${timer.name}</h2>
          <p>${timer.remaining_seconds > 0 ? formatRemaining(timer.remaining_seconds) : 'Finished!'}</p>
        </div>
        <button class="text-red-500 font-bold hover:text-red-700">X</button>
      `;
      const btn = div.querySelector('button');
      btn.onclick = async () => {
        await deleteTimer(timer.id);
        await loadAndRender();
      };
      container.appendChild(div);
    });
  }

  async function loadAndRender() {
    const timers = await fetchTimers();
    renderTimers(timers);
  }

  // Refresh timers every second
  setInterval(loadAndRender, 1000);

  // Initial load
  loadAndRender();

  // Add timer form
  document.getElementById('add-timer-form').addEventListener('submit', async e => {
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const duration = document.getElementById('duration').value.trim();
    if (!name || !duration) return alert('Enter name and duration!');
    await addTimer(name, duration);
    e.target.reset();
    await loadAndRender();
  });
</script>
</body>
</html>
